 "use client";

import { useEffect, useMemo, useState } from "react";
import { toast } from "react-toastify";
import TrackedHours from "@/components/time-tracking/TrackedHours";

type ActiveSession = {
  id: string;
  clockIn: string;
  note?: string;
};

type TodaySession = {
  id: string;
  clockIn: string;
  clockOut?: string | null;
  durationMinutes?: number;
};

type ProjectOption = {
  id: string;
  name: string;
};

type Allocation = {
  projectId: string;
  hours: number;
  notes?: string;
};

export default function TimeTrackingPage() {
  const [active, setActive] = useState<ActiveSession | null>(null);
  const [todaySessions, setTodaySessions] = useState<TodaySession[]>([]);
  const [projects, setProjects] = useState<ProjectOption[]>([]);
  const [loading, setLoading] = useState(true);
  const [busy, setBusy] = useState(false);
  const [note, setNote] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [now, setNow] = useState<Date | null>(null);
  const [mounted, setMounted] = useState(false);



















































































































































































































































































































































































































































































































































}  );    </div>      )}        </div>          </div>            </div>              })}                );                  </div>                    <span className="text-sm font-semibold text-slate-700">{duration}</span>                    </div>                      <span className="text-xs text-slate-500">Session</span>                      </span>                        {start} – {end}                      <span className="text-sm font-medium text-slate-900">                    <div className="flex flex-col">                  >                    className="flex items-center justify-between rounded-lg bg-slate-50 border border-slate-200 px-4 py-3 hover:bg-slate-100 transition"                    key={s.id}                  <div                return (                    : '--:--';                        .padStart(2, '0')}`                        .toString()                        .padStart(2, '0')}:${(s.durationMinutes % 60)                        .toString()                    ? `${Math.floor(s.durationMinutes / 60)                  s.durationMinutes != null                const duration =                  : '—';                    })                      minute: '2-digit'                      hour: '2-digit',                  ? new Date(s.clockOut).toLocaleTimeString([], {                const end = s.clockOut                });                  minute: '2-digit'                  hour: '2-digit',                const start = new Date(s.clockIn).toLocaleTimeString([], {              {todaySessions.map((s) => {              )}                <p className="text-slate-600 text-center py-8">No sessions today</p>              {todaySessions.length === 0 && (            <div className="p-6 max-h-96 overflow-y-auto space-y-3">            </div>              </button>                ✕              >                className="text-slate-400 hover:text-slate-600 text-xl"                onClick={() => setShowHistoryModal(false)}                type="button"              <button              <h2 className="text-lg font-bold text-slate-900">Today's Sessions</h2>            <div className="border-b border-slate-200 p-6 flex items-center justify-between">          <div className="w-full max-w-lg rounded-2xl bg-white border border-slate-200 shadow-lg">        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/30 px-4">      {showHistoryModal && (      )}        </div>          </div>            </div>              </button>                {busy ? 'Saving...' : 'Save & Clock Out'}              >                className="rounded-lg bg-red-500 px-6 py-2 text-sm font-semibold text-white hover:bg-red-600 disabled:bg-red-300 disabled:cursor-not-allowed transition shadow-md"                onClick={() => void submitClockOut()}                disabled={busy}                type="button"              <button              </button>                Cancel              >                className="rounded-lg border border-slate-300 px-4 py-2 text-sm font-medium text-slate-900 hover:bg-slate-50 transition"                onClick={() => setShowClockOutModal(false)}                type="button"              <button            <div className="mt-6 flex items-center justify-end gap-3">            </div>              />                placeholder="Anything important about this shift?"                className="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200"                onChange={(e) => setClockOutNote(e.target.value)}                value={clockOutNote}                rows={3}              <textarea              </label>                Notes (optional)              <label className="mb-2 block text-sm font-medium text-slate-900">            <div className="mt-4">            </div>              })}                );                  </div>                    )}                      />                        className="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200"                        placeholder="Notes for this project..."                        }}                          );                            )                                : a                                ? { ...a, notes: e.target.value }                              a.projectId === p.id                            prev.map((a) =>                          setAllocations((prev) =>                        onChange={(e) => {                        value={current.notes || ""}                        type="text"                      <input                    {current && (                    </div>                      )}                        />                          placeholder="0.0"                          className="h-9 w-20 rounded-md border border-slate-300 bg-white px-2 text-right text-sm text-slate-900 outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200"                          }}                            );                              )                                  : a                                  ? { ...a, hours: isNaN(value) ? 0 : value }                                a.projectId === p.id                              prev.map((a) =>                            setAllocations((prev) =>                            const value = parseFloat(e.target.value || "0");                          onChange={(e) => {                          value={current.hours}                          step={0.25}                          min={0}                          type="number"                        <input                      {current && (                      </label>                        <span>{p.name}</span>                        />                          }}                            }                              );                                prev.filter((a) => a.projectId !== p.id)                              setAllocations((prev) =>                            } else {                              ]);                                { projectId: p.id, hours: 0, notes: "" }                                ...prev,                              setAllocations((prev) => [                            if (e.target.checked) {                          onChange={(e) => {                          checked={!!current}                          className="h-4 w-4 accent-orange-600"                          type="checkbox"                        <input                      <label className="flex items-center gap-3 text-sm text-slate-900 cursor-pointer">                    <div className="flex items-center justify-between">                  >                    className="space-y-2 border-b border-slate-200 px-4 py-4 last:border-b-0 hover:bg-slate-100 transition"                    key={p.id}                  <div                  return (                  const current = allocations.find((a) => a.projectId === p.id);                {projects.map((p) => {                )}                  </p>                    No projects assigned. You can still clock out without allocations.                  <p className="px-4 py-4 text-sm text-slate-600 text-center">                {projects.length === 0 && (              <div className="max-h-96 overflow-y-auto rounded-lg border border-slate-200 bg-slate-50 mb-6">              )}                </div>                  {allocError}                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">              {allocError && (            <div className="p-6">            </div>              </button>                ✕              >                className="text-slate-400 hover:text-slate-600 text-xl"                onClick={() => setShowClockOutModal(false)}                type="button"              <button              </div>                </p>                  Select projects and enter hours worked before clocking out                <p className="text-sm text-slate-600 mt-1">                <h2 className="text-lg font-bold text-slate-900">Allocate today's hours</h2>              <div>            <div className="border-b border-slate-200 p-6 flex items-center justify-between">          <div className="w-full max-w-2xl rounded-2xl bg-white border border-slate-200 shadow-lg">        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/30 px-4">
n      {showClockOutModal && active && (      <TrackedHours />
n      {/* Tracked Hours Section */}      </div>        </div>          </div>            })}              );                </div>                  <span className="text-sm font-semibold text-slate-700">{duration}</span>                  </div>                    <span className="text-xs text-slate-500">Session</span>                    </span>                      {start} – {end}                    <span className="text-sm font-medium text-slate-900">                  <div className="flex flex-col">                >                  className="flex items-center justify-between rounded-lg bg-slate-50 border border-slate-200 px-3 py-2 hover:bg-slate-100 transition"                  key={s.id}                <div              return (                  : '--:--';                      .padStart(2, '0')}`                      .toString()                      .padStart(2, '0')}:${(s.durationMinutes % 60)                      .toString()                  ? `${Math.floor(s.durationMinutes / 60)                s.durationMinutes != null              const duration =                : '—';                  })                    minute: '2-digit'                    hour: '2-digit',                ? new Date(s.clockOut).toLocaleTimeString([], {              const end = s.clockOut              });                minute: '2-digit'                hour: '2-digit',              const start = new Date(s.clockIn).toLocaleTimeString([], {            {todayShortHistory.map((s) => {            )}              <p className="text-slate-500 text-sm py-4 text-center">No sessions yet today</p>            {todayShortHistory.length === 0 && (
n          <div className="space-y-3">          </div>            </button>              View All            >              className="text-orange-600 hover:text-orange-700 text-xs font-semibold"              onClick={() => setShowHistoryModal(true)}              type="button"            <button            </div>              <p className="text-xs text-slate-500 mt-1">Recent sessions</p>              <h3 className="font-semibold text-slate-900 text-sm">Today's History</h3>            <div>          <div className="flex items-center justify-between mb-4">        <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">        {/* Today's History Card */}        </div>          </div>            </p>                : 'Starts 09:00 AM · No Overtime'}                ? `Clocked in at ${clockInTime} · Running timer`              {isClockedIn            <p className="text-center text-sm text-slate-600">            </button>                : 'Clock In'}                ? 'Clock Out'                : isClockedIn                  : 'Clocking in...'                  ? 'Clocking out...'                ? isClockedIn              {busy            >              } disabled:cursor-not-allowed shadow-md`}                  : 'bg-orange-500 hover:bg-orange-600 disabled:bg-orange-300'                  ? 'bg-red-500 hover:bg-red-600 disabled:bg-red-300'                isClockedIn              className={`w-full py-3 px-6 rounded-lg font-semibold text-white text-sm transition-all ${              }                  : () => void handleClockIn()                  ? () => openClockOutModal()                isClockedIn              onClick={              disabled={busy || loading}              type="button"            <button
n          <div className="mt-8 flex flex-col gap-3">          )}            </div>              {error}            <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">          {error && (          </div>            </p>              {isClockedIn ? '● Clocked In' : '○ Not Clocked In'}            }`}>                : 'bg-slate-100 text-slate-700'                ? 'bg-orange-100 text-orange-700'               isClockedIn             <p className={`inline-block text-xs font-semibold px-3 py-1 rounded-full ${            </p>              {currentTimeLabel}            <p className="text-5xl font-bold text-slate-900 mb-4 font-mono">            </p>              {todayLabel}            <p className="text-xs uppercase tracking-widest text-slate-500 font-semibold mb-2">          <div>        <div className="lg:col-span-2 bg-white rounded-2xl p-8 shadow-sm border border-slate-200">        {/* Clock In/Out Card */}      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
n      {/* Main Grid */}      </div>        </button>          Month        >          className="py-3 px-0 border-b-2 border-orange-500 text-orange-600 font-medium text-sm transition"          onClick={() => {}}        <button        </button>          Week        >          className="py-3 px-0 border-b-2 border-slate-300 text-slate-600 font-medium text-sm hover:text-slate-900 transition"          onClick={() => {}}        <button        </button>          Day        >          className="py-3 px-0 border-b-2 border-slate-300 text-slate-600 font-medium text-sm hover:text-slate-900 transition"          onClick={() => {}}        <button      <div className="flex gap-6 border-b border-slate-200">
n      {/* View Tabs */}      </div>        </p>          Track your working hours, manage breaks, and monitor productivity        <p className="mt-1 text-sm text-slate-600">        <h1 className="text-3xl font-bold text-slate-900">Time Tracking</h1>      <div>      {/* Page Header */}    <div className="space-y-6 p-6">  return (  );    [todaySessions]    () => todaySessions.slice(-3),
n  const todayShortHistory = useMemo(  }) : "--:--:--";    hour12: false
n  const currentTimeLabel = now ? now.toLocaleTimeString(undefined, {  }) : "Loading...";    day: "numeric"    month: "long",    weekday: "long",
n  const todayLabel = now ? now.toLocaleDateString(undefined, {    : null;      })        minute: "2-digit"        hour: "2-digit",    ? new Date(active.clockIn).toLocaleTimeString([], {  const clockInTime = active  const isClockedIn = !!active;  }    }      setBusy(false);    } finally {      toast.error(errorMsg);      setError(errorMsg);      console.error(e);      const errorMsg = e instanceof Error ? e.message : "Failed to clock out.";    } catch (e) {      }        toast.success("Clocked out successfully!");      } else {        toast.success(`Clocked out! Allocated: ${projectNames}`);          .join(", ");          })            return `${project?.name} (${a.hours}h)`;            const project = projects.find(p => p.id === a.projectId);          .map(a => {          .filter(a => a.hours > 0)        const projectNames = allocations      if (projectCount > 0) {      const projectCount = allocations.filter(a => a.hours > 0).length;      // Show success message with project details            await loadTodaySessions();      setShowClockOutModal(false);      setActive(null);      }        throw new Error(body?.error || "Failed to clock out");          | null;          | { error?: string }        const body = (await res.json().catch(() => null)) as      if (!res.ok) {      });        })          note: clockOutNote || undefined          allocations,        body: JSON.stringify({        },          "Content-Type": "application/json"        headers: {        method: "POST",      const res = await fetch("/api/time-entries/clock-out", {    try {    }      return;      toast.error(msg);      setAllocError(msg);      const msg = "Project hours cannot exceed total worked time.";      setBusy(false);    if (totalAllocatedMinutes > totalMinutes) {    );      0      (sum, a) => sum + a.hours * 60,    const totalAllocatedMinutes = allocations.reduce(    const totalMinutes = Math.max(Math.round(diffMs / 60000), 0);    const diffMs = Date.now() - clockInDate.getTime();    const clockInDate = new Date(active.clockIn);    setError(null);    setAllocError(null);    setBusy(true);    if (!active) return;  async function submitClockOut() {  }    void loadProjectsForUser();    setShowClockOutModal(true);    setAllocError(null);    setClockOutNote("");    setAllocations([]);
n  function openClockOutModal() {  }    }      setBusy(false);    } finally {      toast.error(errorMsg);      setError(errorMsg);      console.error(e);      const errorMsg = e instanceof Error ? e.message : "Failed to clock in.";    } catch (e) {      toast.success("Clocked in successfully!");      await loadTodaySessions();      setNote("");      setActive(data);      const data = (await res.json()) as ActiveSession;      }        throw new Error(body?.error || "Failed to clock in");          | null;          | { error?: string }        const body = (await res.json().catch(() => null)) as      if (!res.ok) {      });        body: JSON.stringify({ note: note || undefined })        },          "Content-Type": "application/json"        headers: {        method: "POST",      const res = await fetch("/api/time-entries/clock-in", {    try {    setError(null);    setBusy(true);  async function handleClockIn() {  }, []);    return () => clearInterval(id);    const id = setInterval(() => setNow(new Date()), 1000);    setNow(new Date());    setMounted(true);  useEffect(() => {  }, []);    );      setLoading(false)    Promise.all([loadActive(), loadTodaySessions()]).finally(() =>    setLoading(true);  useEffect(() => {  }    }      // ignore    } catch {      setProjects(data.map((p) => ({ id: p.id, name: p.name })));      }[];        name: string;        id: string;      const data = (await res.json()) as {      if (!res.ok) return;      const res = await fetch("/api/projects?forCurrentUser=true");    try {  async function loadProjectsForUser() {  }    }      // ignore    } catch {      setTodaySessions(data.sessions);      const data = (await res.json()) as { sessions: TodaySession[] };      if (!res.ok) return;      const res = await fetch("/api/time-entries/today");    try {  async function loadTodaySessions() {  }    }      setError("Could not load current session.");      console.error(e);    } catch (e) {      setActive(data.active);      const data = (await res.json()) as { active: ActiveSession | null };      }        throw new Error("Unable to load current session");      if (!res.ok) {      }        return;        setActive(null);      if (res.status === 401) {      const res = await fetch("/api/time-entries/active");    try {    setError(null);
n  async function loadActive() {  const [showHistoryModal, setShowHistoryModal] = useState(false);  const [allocError, setAllocError] = useState<string | null>(null);  const [clockOutNote, setClockOutNote] = useState("");  const [allocations, setAllocations] = useState<Allocation[]>([]);n  const [showClockOutModal, setShowClockOutModal] = useState(false);